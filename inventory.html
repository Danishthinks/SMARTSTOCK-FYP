<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory - SMARTSTOCK</title>
<style>
:root{
  --bg:#f5f7fa;
  --sidebar:#1f2937;
  --primary:#2563eb;
  --white:#fff;
  --text-dark:#111827;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial, Helvetica, sans-serif;}
body{display:flex;background:var(--bg);}

.sidebar{background:var(--sidebar);color:#fff;height:100vh;position:fixed;padding:25px;display:flex;flex-direction:column;width:210px}
.logo{font-size:22px;font-weight:600;margin-bottom:25px;text-align:center;}
.nav-link{color:#d1d5db;text-decoration:none;display:block;padding:12px;border-radius:8px;margin-bottom:8px;font-size:15px;}
.nav-link:hover, .nav-link.active{background:rgba(255,255,255,0.12);color:#fff;}

/* User section */
.user-info{margin-top:auto;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);font-size:14px;color:#d1d5db}
.logout-btn{background:none;border:none;color:#d1d5db;padding:5px 0;margin-top:8px;cursor:pointer;font-size:14px;width:100%;text-align:left}
.logout-btn:hover{color:#fff}

/* Main content */
.main{margin-left:230px;padding:35px;width:100%}
.heading{font-size:22px;font-weight:bold;margin-bottom:20px;color:var(--text-dark)}
table{width:100%;border-collapse:collapse;background:white;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:14px}
th{background:#eef2ff;font-weight:bold;color:#111}
.low-stock td{color:#b00020}
.badge{background:#dc2626;color:#fff;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold;margin-left:5px}
.loading-row td{padding:20px;text-align:center;color:#666}
.action-btn{cursor:pointer;padding:6px 10px;border-radius:6px;font-size:13px;border:none;margin-right:5px}
.edit{background:#facc15;color:#000}
.delete{background:#ef4444;color:#fff}

/* Hide the print-area off-screen so printable HTML never shows in the page */
#print-area{position:absolute;left:-9999px;top:0;width:1px;height:1px;overflow:hidden}

/* Dark theme overrides */
:root[data-theme="dark"], [data-theme="dark"] {
  --bg: #071025;
  --sidebar: #0b1220;
  --primary: #3b82f6;
  --white: #0f1724;
  --text-dark: #e6eef8;
}

/* Toasts */
#toastContainer{position:fixed;right:18px;bottom:18px;z-index:11000;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
.toast{min-width:220px;max-width:360px;padding:10px 12px;border-radius:8px;color:#fff;box-shadow:0 8px 24px rgba(2,6,23,0.4);font-weight:600;opacity:0;transform:translateY(12px);transition:all 240ms cubic-bezier(.2,.9,.3,1)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{background:linear-gradient(90deg,#10b981,#059669)}
.toast.error{background:linear-gradient(90deg,#ef4444,#dc2626)}
.toast.info{background:linear-gradient(90deg,#2563eb,#1e40af)}
.toast .toast-msg{font-weight:600;font-size:13px}
.toast .toast-sub{font-weight:400;font-size:12px;opacity:0.9;margin-top:6px}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="theme.js"></script>

</head>
<body>
<div class="sidebar">
  <div class="logo">SMARTSTOCK</div>
  <a class="nav-link" href="index.html">Dashboard</a>
  <a class="nav-link" href="add-inventory.html">Add Product</a>
  <a class="nav-link active" href="inventory.html">Inventory List</a>
  <a class="nav-link" href="logs.html">Activity Logs</a>
  
  <!-- User info and logout -->
    <div class="user-info">
    <div id="userEmail">Loading...</div>
    <div style="display:flex;gap:8px;flex-direction:column;margin-top:8px;">
      <button id="themeToggleBtn" class="logout-btn" style="text-align:left;">Theme</button>
      <button class="logout-btn" onclick="logout(event)">Logout</button>
    </div>
  </div>
</div>
  
  <!-- Product history modal -->
  <div id="historyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10001;align-items:center;justify-content:center;">
    <div style="background:#fff;width:95%;max-width:800px;border-radius:8px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,0.3);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <strong id="historyTitle">Product History</strong>
        <div>
          <button onclick="closeHistory()" style="background:#ef4444;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
        </div>
      </div>
      <div id="historyContent" style="max-height:60vh;overflow:auto;padding-top:6px;">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f3f4f6"><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">Time</th><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">User</th><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">Action</th><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">Quantity</th></tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
      <!-- Toast container -->
      <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
<div class="main">
  <div class="heading" style="display:flex; justify-content:space-between; align-items:center;">
    <span>Inventory List</span>
    <div style="display:flex; gap:10px;">
      <input id="searchInput" placeholder="Search product..." style="padding:8px;border:1px solid #ccc;border-radius:6px;width:200px;" onkeyup="filterProducts()">
      <select id="categoryFilter" style="padding:8px;border:1px solid #ccc;border-radius:6px;" onchange="filterProducts()">
        <option value="">All Categories</option>
      </select>
      <button onclick="exportInventoryExcel()" 
style="padding:8px 12px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">
  Export Excel
</button>

  <button onclick="exportInventoryPDF()" style="padding:8px 12px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer;">Export PDF</button>

    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th>Name</th><th>Category</th><th>Qty</th><th>Buy Price</th><th>Sell Price</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="productTable">
      <tr class="loading-row"><td colspan="6">Loading products...</td></tr>
    </tbody>
  </table>
  
  <!-- Undo banner (hidden by default) -->
  <div id="undoBanner" style="display:none;position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:9999;align-items:center;gap:10px;">
    <span id="undoMsg">Action performed</span>
    <button id="undoBtn" style="background:#10b981;border:none;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700">Undo</button>
    <button id="viewChangesBtn" style="background:#2563eb;border:none;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700;display:none">View Changes</button>
    <button id="undoClose" style="background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer">Close</button>
  </div>

  <!-- Diff modal -->
  <div id="diffModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10000;align-items:center;justify-content:center;">
    <div style="background:#fff;width:90%;max-width:760px;border-radius:10px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.3);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <strong>Changes (Before → After)</strong>
        <button onclick="hideDiff()" style="background:#ef4444;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
      </div>
      <div style="max-height:60vh;overflow:auto;">
        <table id="diffTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f3f4f6"><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">Field</th><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">Before</th><th style="padding:8px;border:1px solid #e5e7eb;text-align:left">After</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>
<script src="firebase-logs.js"></script>

<script>
// Add auth guard and initialize products when document is ready
document.addEventListener('DOMContentLoaded', function() {
  // Check auth first
  if (typeof auth === 'undefined') {
    console.error('Auth not initialized');
    window.location.href = 'login.html';
    return;
  }

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    // Show user email
    const userEmail = document.getElementById('userEmail');
    if (userEmail) userEmail.textContent = user.email;
    // Initialize products after auth
    initializeProducts();
  });
});

// Logout function
function logout(ev) {
  if (typeof auth !== 'undefined') {
    const btn = ev && ev.target ? ev.target : null;
    if (btn) { btn.disabled = true; btn.textContent = 'Logging out...'; }

    auth.signOut()
      .then(() => window.location.href = 'login.html')
      .catch(err => {
        console.error('Logout error:', err);
        if (btn) { btn.disabled = false; btn.textContent = 'Logout'; }
        alert('Error logging out: ' + err.message);
      });
  }
}

// Store products for filtering
let productsData = [];
const tableEl = document.getElementById('productTable');

// Helper functions
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[m]);
}

function showLoading() {
  if (tableEl) {
    tableEl.innerHTML = '<tr class="loading-row"><td colspan="6">Loading products...</td></tr>';
  }
}

function showError(message) {
  if (tableEl) {
    tableEl.innerHTML = `<tr><td colspan="6" style="color:#b00020">Error: ${escapeHtml(message)}</td></tr>`;
  }
  console.error(message);
}

// Initialize products after checking auth and db
function initializeProducts() {
  if (!tableEl) {
    console.error('Product table element not found');
    return;
  }

  showLoading();

  if (!window.db) {
    showError('Database not initialized. Please refresh the page.');
    return;
  }

  // Verify auth before loading data
  if (!auth.currentUser) {
    showError('Please log in to view products');
    setTimeout(() => window.location.href = 'login.html', 1000);
    return;
  }

  // Initialize Firestore listener
  try {
    db.collection("products")
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        productsData = [];
        let categories = new Set();
        
        // Process snapshot data
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data) {
            productsData.push({ ...data, id: doc.id });
            if (data.category) categories.add(data.category);
          }
        });

        // Update category filter
        const catSelect = document.getElementById("categoryFilter");
        if (catSelect) {
          catSelect.innerHTML = '<option value="">All Categories</option>';
          Array.from(categories).sort().forEach(category => {
            catSelect.innerHTML += `<option value="${escapeHtml(category)}">${escapeHtml(category)}</option>`;
          });
        }

        // Render the table
        if (productsData.length === 0) {
          tableEl.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666">No products found</td></tr>';
        } else {
          renderTable(productsData);
        }
      }, error => {
        showError(error.message || 'Error loading products');
      });
  } catch (error) {
    showError('Failed to initialize product listener: ' + error.message);
  }
}

function renderTable(data) {
  if (!tableEl) return;
  
  let html = "";
  data.forEach(p => {
    // Safely access properties with defaults
    const quantity = p.quantity != null ? p.quantity : 0;
    const low = quantity < 5;
    const name = p.name || '';
    const category = p.category || '';
    const purchasePrice = p.purchasePrice != null ? p.purchasePrice : 0;
    const sellingPrice = p.sellingPrice != null ? p.sellingPrice : 0;

    html += `
      <tr class="${low ? 'low-stock' : ''}">
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(category)}</td>
        <td>${quantity}${low ? '<span class="badge">Low</span>' : ''}</td>
        <td>Rs. ${purchasePrice.toLocaleString()}</td>
        <td>Rs. ${sellingPrice.toLocaleString()}</td>
            <td>
              <button class="action-btn edit" onclick="editProduct('${escapeHtml(p.id)}')">Edit</button>
              <button class="action-btn edit" onclick="adjustStock('${escapeHtml(p.id)}')">Adjust</button>
              <button class="action-btn" style="background:#6b7280;color:#fff" onclick="viewHistory('${escapeHtml(name)}')">History</button>
              <button class="action-btn delete" onclick="deleteProduct('${escapeHtml(p.id)}', event)">Delete</button>
            </td>
      </tr>`;
  });
  
  tableEl.innerHTML = html;
}

function filterProducts() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const cat = document.getElementById('categoryFilter').value;
  
  // Handle empty data
  if (!productsData.length) {
    tableEl.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666">No products found</td></tr>';
    return;
  }

  const filtered = productsData.filter(p => {
    const nameMatch = p.name?.toLowerCase().includes(search);
    const catMatch = !cat || p.category === cat;
    return nameMatch && catMatch;
  });

  if (filtered.length === 0) {
    tableEl.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666">No matching products found</td></tr>';
    return;
  }

  renderTable(filtered);
}

function deleteProduct(id, ev) {
  if (!window.db) { 
    alert('Database not ready. Please refresh the page.');
    return;
  }

  if (!confirm('Are you sure you want to delete this product?')) return;

  const btn = ev && ev.target ? ev.target : null;
  if (btn) { btn.disabled = true; btn.textContent = 'Deleting...'; }

  // Get the product data first for the log and for undo
  db.collection('products').doc(id).get()
    .then(doc => {
      if (doc.exists) {
        const product = doc.data();
        // Delete the product
        return db.collection('products').doc(id).delete()
          .then(() => {
            // Log after successful deletion
            addLog("DELETE PRODUCT", product.name || '', product.quantity || 0);
            // Save last action to allow undo (persist to localStorage so inventory page reload can still show undo)
            const last = { type: 'delete', id: id, data: product, time: Date.now() };
            try { localStorage.setItem('smartstock_last_action', JSON.stringify(last)); } catch(e) { console.warn('Unable to store last action', e); }
            showUndoBanner(last);
            try { showToast(`Deleted "${product.name || 'product'}"`, 'info', 3500); } catch(e) {}
            // Table will update automatically via snapshot
          });
      }
    })
    .catch(err => {
      console.error('Delete error:', err);
      try { showToast('Error deleting product: ' + (err.message || err), 'error', 4000); } catch(e) { alert('Error deleting product: ' + (err.message || err)); }
      btn.disabled = false;
      btn.textContent = 'Delete';
    });
}

// ----- Undo helpers -----
function setLastAction(obj) {
  try { localStorage.setItem('smartstock_last_action', JSON.stringify(obj)); } catch(e) { console.warn('setLastAction failed', e); }
}

function clearLastAction() {
  try { localStorage.removeItem('smartstock_last_action'); } catch(e) { console.warn('clearLastAction failed', e); }
  hideUndoBanner();
}

function showUndoBanner(action) {
  const banner = document.getElementById('undoBanner');
  const msg = document.getElementById('undoMsg');
  const undoBtn = document.getElementById('undoBtn');
  const closeBtn = document.getElementById('undoClose');
  if (!banner || !msg || !undoBtn || !closeBtn) return;

  if (!action) {
    try { action = JSON.parse(localStorage.getItem('smartstock_last_action')); } catch(e) { action = null; }
  }
  if (!action) return;

  if (action.type === 'delete') {
    msg.textContent = `Deleted "${action.data?.name || 'product'}" — undo?`;
    // hide view changes button for delete
    const viewBtn = document.getElementById('viewChangesBtn'); if (viewBtn) viewBtn.style.display = 'none';
  } else if (action.type === 'update') {
    msg.textContent = `Updated "${action.data?.name || 'product'}" — undo or view changes?`;
    // show view changes button
    const viewBtn = document.getElementById('viewChangesBtn'); if (viewBtn) { viewBtn.style.display = 'inline-block'; viewBtn.onclick = function() { showDiff(action); } }
  } else {
    msg.textContent = 'Action performed — undo?';
  }

  banner.style.display = 'flex';

  // attach handlers
  undoBtn.onclick = function() { undoLastAction(); };
  closeBtn.onclick = function() { clearLastAction(); };

  // auto-hide after 30 seconds
  if (banner._hideTimer) clearTimeout(banner._hideTimer);
  banner._hideTimer = setTimeout(() => { hideUndoBanner(); }, 30000);
}

function hideUndoBanner() {
  const banner = document.getElementById('undoBanner');
  if (banner) { banner.style.display = 'none'; if (banner._hideTimer) clearTimeout(banner._hideTimer); }
}

function undoLastAction() {
  let action = null;
  try { action = JSON.parse(localStorage.getItem('smartstock_last_action')); } catch(e) { action = null; }
  if (!action) { try { showToast('Nothing to undo','info',2500);}catch(e){ } hideUndoBanner(); return; }

  if (!window.db) { alert('Database not initialized. Refresh the page.'); return; }

  if (action.type === 'delete') {
    // Recreate document with same id
    const restoreData = Object.assign({}, action.data || {});
    // remove any metadata that might be invalid; we'll set restoredAt
    restoreData.restoredAt = firebase.firestore.FieldValue.serverTimestamp();
    db.collection('products').doc(action.id).set(restoreData)
      .then(() => {
          try { addLog('RESTORE PRODUCT', restoreData.name || '', restoreData.quantity || 0); } catch(e) { console.warn(e); }
          clearLastAction();
          try { showToast('Product restored','success',3000); } catch(e) {}
        })
      .catch(err => { console.error('Restore failed', err); alert('Restore failed: ' + (err.message || err)); });
  } else if (action.type === 'update') {
    const prev = action.data || {};
    db.collection('products').doc(action.id).set(prev)
      .then(() => {
        try { addLog('UNDO UPDATE', prev.name || '', prev.quantity || 0); } catch(e) { console.warn(e); }
        clearLastAction();
        try { showToast('Update undone','success',3000); } catch(e) {}
      })
      .catch(err => { console.error('Undo update failed', err); alert('Undo failed: ' + (err.message || err)); });
  } else {
    alert('Unknown action to undo'); hideUndoBanner();
  }
}

// Diff modal helpers
function showDiff(action) {
  try {
    if (!action) action = JSON.parse(localStorage.getItem('smartstock_last_action'));
  } catch(e) { action = null; }
  if (!action) return;

  const tbody = document.querySelector('#diffTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  // Fields to show in the diff
  const fields = [
    { key: 'name', label: 'Name' },
    { key: 'category', label: 'Category' },
    { key: 'quantity', label: 'Quantity' },
    { key: 'purchasePrice', label: 'Purchase Price' },
    { key: 'sellingPrice', label: 'Selling Price' }
  ];

  const before = action.data || {};
  const after = action.updated || {};

  fields.forEach(f => {
    const b = before[f.key] != null ? String(before[f.key]) : '';
    const a = after[f.key] != null ? String(after[f.key]) : '';
    const changed = b !== a;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:8px;border:1px solid #e5e7eb">${f.label}</td><td style="padding:8px;border:1px solid #e5e7eb">${escapeHtml(b)}</td><td style="padding:8px;border:1px solid #e5e7eb">${escapeHtml(a)}</td>`;
    if (changed) {
      tr.style.background = '#fffbeb';
    }
    tbody.appendChild(tr);
  });

  const modal = document.getElementById('diffModal'); if (modal) modal.style.display = 'flex';
}

function hideDiff(){ const modal = document.getElementById('diffModal'); if (modal) modal.style.display = 'none'; }

// On load, if there is a pending last action saved, show the banner
document.addEventListener('DOMContentLoaded', function() {
  try {
    const saved = JSON.parse(localStorage.getItem('smartstock_last_action'));
    // show only if within last 2 minutes
    if (saved && saved.time && (Date.now() - saved.time) < 2 * 60 * 1000) {
      showUndoBanner(saved);
    }
  } catch(e) { /* ignore */ }
});

// ----- Product history (per-product logs) -----
function viewHistory(productName) {
  if (!productName) { try { showToast('Product name missing','error',2500); } catch(e) {} return; }
  if (!window.db) return alert('Database not initialized');

  const title = document.getElementById('historyTitle');
  const body = document.getElementById('historyTableBody');
  const modal = document.getElementById('historyModal');
  if (!body || !modal) return;

  title.textContent = `History — ${productName}`;
  body.innerHTML = '<tr><td colspan="4" style="padding:12px;text-align:center;color:#666">Loading...</td></tr>';
  modal.style.display = 'flex';

  try {
    // Fetch matching logs without server-side ordering to avoid needing a composite index.
    // We'll sort by timestamp client-side.
    db.collection('logs')
      .where('productName', '==', productName)
      .limit(500)
      .get()
      .then(snap => {
        const docs = [];
        snap.forEach(doc => docs.push(doc));

        // Sort documents by timestamp (newest first). Some entries may not have timestamp yet.
        docs.sort((a, b) => {
          const at = a.data().timestamp ? a.data().timestamp.toMillis() : 0;
          const bt = b.data().timestamp ? b.data().timestamp.toMillis() : 0;
          return bt - at;
        });

        const rows = docs.map(doc => {
          const d = doc.data();
          const time = d.timestamp ? d.timestamp.toDate().toLocaleString() : '--';
          return `<tr><td style="padding:8px;border:1px solid #e5e7eb">${escapeHtml(time)}</td><td style="padding:8px;border:1px solid #e5e7eb">${escapeHtml(d.user||'')}</td><td style="padding:8px;border:1px solid #e5e7eb">${escapeHtml(d.action||'')}</td><td style="padding:8px;border:1px solid #e5e7eb">${escapeHtml(String(d.quantity ?? ''))}</td></tr>`;
        });

        if (!rows.length) {
          body.innerHTML = '<tr><td colspan="4" style="padding:12px;text-align:center;color:#666">No history found for this product</td></tr>';
        } else {
          body.innerHTML = rows.join('');
        }
      })
      .catch(err => {
        console.error('History fetch error', err);
        body.innerHTML = `<tr><td colspan="4" style="padding:12px;text-align:center;color:#b00020">Error loading history: ${escapeHtml(err.message||err)}</td></tr>`;
      });
  } catch (err) {
    console.error('History query failed', err);
    body.innerHTML = `<tr><td colspan="4" style="padding:12px;text-align:center;color:#b00020">Error: ${escapeHtml(err.message||err)}</td></tr>`;
  }
}

function closeHistory(){ const modal = document.getElementById('historyModal'); if (modal) modal.style.display = 'none'; }

// ----- Toast helpers -----
function createToastEl(msg, type) {
  const el = document.createElement('div');
  el.className = `toast ${type || 'info'}`;
  el.innerHTML = `<div class="toast-msg">${escapeHtml(msg.message || msg)}</div>${msg.sub ? `<div class="toast-sub">${escapeHtml(msg.sub)}</div>` : ''}`;
  return el;
}

function showToast(message, type = 'info', duration = 3000, sub = '') {
  try {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const payload = typeof message === 'object' ? message : { message, sub };
    const el = createToastEl(payload, type);
    container.appendChild(el);
    // Force reflow to run transition
    requestAnimationFrame(() => el.classList.add('show'));
    const hide = () => {
      el.classList.remove('show');
      setTimeout(() => { try { el.remove(); } catch(e){} }, 240);
    };
    const timer = setTimeout(hide, duration || 3000);
    // allow click to dismiss
    el.addEventListener('click', () => { clearTimeout(timer); hide(); });
  } catch (e) { console.warn('showToast error', e); }
}

// Show queued toast if any (used when redirecting from edit page)
function flushQueuedToast() {
  try {
    const raw = localStorage.getItem('smartstock_toast');
    if (!raw) return;
    const t = JSON.parse(raw);
    if (t && t.message) showToast(t.message, t.type || 'info', t.duration || 3000, t.sub || '');
    localStorage.removeItem('smartstock_toast');
  } catch(e) { localStorage.removeItem('smartstock_toast'); }
}

// Ensure queued toast gets shown on load
document.addEventListener('DOMContentLoaded', function() { flushQueuedToast(); });

function editProduct(id) {
  window.location.href = `inventory-edit.html?id=${encodeURIComponent(id)}`;
}

function adjustStock(id) {
  window.location.href = `inventory-adjust.html?id=${encodeURIComponent(id)}`;
}

</script>

<!-- Export inventory to CSV (works with Excel). Uses current filters. -->
<script>
function escapeCsv(value) {
  if (value == null) return '';
  const s = String(value);
  // Double quotes escape
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return '"' + s.replace(/"/g, '""') + '"';
  }
  return s;
}

function getFilteredProducts() {
  const search = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
  const cat = document.getElementById('categoryFilter')?.value || '';
  if (!productsData || !productsData.length) return [];
  return productsData.filter(p => {
    const nameMatch = p.name?.toLowerCase().includes(search);
    const catMatch = !cat || p.category === cat;
    return nameMatch && catMatch;
  });
}

function exportInventoryExcel() {
  const rows = getFilteredProducts();
  if (!rows.length) {
    alert('No products to export');
    return;
  }

  const headers = ['Name', 'Category', 'Quantity', 'Purchase Price', 'Selling Price'];
  let csv = headers.join(',') + '\n';

  rows.forEach(p => {
    const line = [
      escapeCsv(p.name || ''),
      escapeCsv(p.category || ''),
      escapeCsv(p.quantity ?? ''),
      escapeCsv(p.purchasePrice ?? ''),
      escapeCsv(p.sellingPrice ?? '')
    ].join(',');
    csv += line + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  const date = new Date().toISOString().slice(0,10);
  link.download = `Inventory_Report_${date}.csv`;
  document.body.appendChild(link);
  link.click();
  link.remove();
}
</script>

<script>
function exportInventoryPDF() {
  const rows = getFilteredProducts();
  if (!rows || !rows.length) { alert('No products to export'); return; }
  if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF !== 'function') { alert('PDF library not available'); return; }

  try {
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 10;
    const cols = ['Name','Category','Quantity','Purchase Price','Selling Price'];
    const colCount = cols.length;
    const colWidth = (pageWidth - margin*2) / colCount;
    let y = 20;
    pdf.setFontSize(12);
    pdf.text('SMARTSTOCK - Inventory Report', pageWidth/2, 12, { align: 'center' });
    pdf.setFontSize(10);
    cols.forEach((h,i) => pdf.text(String(h), margin + i*colWidth + 2, y));
    y += 6; pdf.setFontSize(9);

    rows.forEach(r => {
      const cells = [r.name||'', r.category||'', String(r.quantity ?? ''), String(r.purchasePrice ?? ''), String(r.sellingPrice ?? '')];
      const cellLines = cells.map(c => pdf.splitTextToSize(String(c), colWidth - 4));
      const maxLines = Math.max(...cellLines.map(arr => arr.length));
      if (y + maxLines*5 > pageHeight - margin) { pdf.addPage(); y = 20; }

      for (let li = 0; li < maxLines; li++) {
        cellLines.forEach((lines, ci) => {
          const text = lines[li] || '';
          pdf.text(text, margin + ci*colWidth + 2, y + li*5);
        });
      }
      y += maxLines*5;
    });

    const date = new Date().toISOString().slice(0,10);
    pdf.save(`Inventory_Report_${date}.pdf`);
  } catch (err) {
    console.error('Inventory PDF export failed:', err);
    alert('PDF export failed.');
  }
}
</script>


</body>
</html>
