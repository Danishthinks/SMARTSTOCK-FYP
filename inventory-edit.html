<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Edit Product - SMARTSTOCK</title>
<style>
:root{
  --bg:#f5f7fa; --sidebar:#1f2937; --primary:#2563eb; --white:#fff; --text:#111827;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial, sans-serif;}
body{display:flex;background:var(--bg);min-height:100vh;}
.sidebar{width:230px;background:var(--sidebar);color:#fff;padding:25px;height:100vh;position:fixed;}
.sidebar .logo{font-weight:700;margin-bottom:20px;text-align:center;}
.sidebar a{display:block;color:#d1d5db;text-decoration:none;padding:10px;border-radius:6px;margin-bottom:6px;}
.sidebar a:hover{background:rgba(255,255,255,0.06);color:#fff;}
.main{margin-left:230px;padding:36px;width:100%;}
.card{background:var(--white);padding:22px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06);max-width:760px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.form-row-single{margin-bottom:12px;}
label{display:block;font-size:13px;color:#374151;margin-bottom:6px;font-weight:600;}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;}
.button{background:var(--primary);color:#fff;padding:11px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;}
.msg{margin-top:10px;font-size:14px;}
.small{font-size:13px;color:#6b7280;}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">SMARTSTOCK</div>
  <a href="index.html">Dashboard</a>
  <a href="inventory.html">Inventory List</a>
  <a href="inventory-add.html">Add Product</a>
  <a href="logs.html">Activity Logs</a>
  <div style="margin-top:auto;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);">
    <button id="themeToggleBtn" onclick="toggleTheme()" style="background:none;border:none;color:#d1d5db;padding:8px 0;width:100%;text-align:left;cursor:pointer">Theme</button>
    <button onclick="logout(event)" style="background:none;border:none;color:#d1d5db;padding:8px 0;width:100%;text-align:left;cursor:pointer">Logout</button>
  </div>
</div>

<div class="main">
  <h2 style="margin-bottom:14px;">Edit Product</h2>

  <div class="card">
    <div id="note" class="small">Loading product...</div>

    <div style="margin-top:12px;">
      <div class="form-row">
        <div>
          <label for="pname">Product Name</label>
          <input id="pname" type="text" placeholder="Product name">
        </div>
        <div>
          <label for="pcategory">Category</label>
          <input id="pcategory" type="text" placeholder="Category">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="pqty">Quantity</label>
          <input id="pqty" type="number" placeholder="Quantity">
        </div>
        <div>
          <label for="pprice">Purchase Price (Rs.)</label>
          <input id="pprice" type="number" placeholder="Purchase price">
        </div>
      </div>

      <div class="form-row-single">
        <label for="psell">Selling Price (Rs.)</label>
        <input id="psell" type="number" placeholder="Selling price">
      </div>

      <div style="display:flex; gap:10px; margin-top:8px;">
        <button class="button" id="updateBtn" onclick="updateProduct()">Update Product</button>
        <button class="button" style="background:#6b7280" onclick="cancelEdit()">Cancel</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>
</div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<!-- your firebase config -->
<script src="firebase.js"></script>
<!-- logs helper -->
<script src="firebase-logs.js"></script>
<script src="theme.js"></script>

<script>
/*
  inventory-edit.html
  - expects URL param ?id=<productDocId>
  - pre-fills fields
  - validates and updates Firestore
  - writes to logs via addLog(...)
*/

const msgEl = document.getElementById('msg');
const noteEl = document.getElementById('note');
const id = new URLSearchParams(window.location.search).get('id');

if (!id) {
  alert('No product id provided.');
  window.location.href = 'inventory.html';
}

// Ensure auth
if (typeof auth !== 'undefined') {
  auth.onAuthStateChanged(u => {
    if (!u) window.location.href = 'login.html';
  });
}

// Elements
const pname = document.getElementById('pname');
const pcategory = document.getElementById('pcategory');
const pqty = document.getElementById('pqty');
const pprice = document.getElementById('pprice');
const psell = document.getElementById('psell');
const updateBtn = document.getElementById('updateBtn');

let original = null; // keep the original doc data for diff/logging

// Fetch product and fill
db.collection('products').doc(id).get().then(doc => {
  if (!doc.exists) {
    alert('Product not found');
    window.location.href = 'inventory.html';
    return;
  }
  original = doc.data();

  pname.value = original.name || '';
  pcategory.value = original.category || '';
  pqty.value = original.quantity != null ? original.quantity : 0;
  pprice.value = original.purchasePrice != null ? original.purchasePrice : 0;
  psell.value = original.sellingPrice != null ? original.sellingPrice : 0;

  noteEl.textContent = 'Editing product ID: ' + id;
}).catch(err => {
  console.error(err);
  alert('Error fetching product.');
  window.location.href = 'inventory.html';
});

// Validate inputs
function validate() {
  msgEl.textContent = '';
  if (!pname.value.trim()) { msgEl.textContent = 'Enter product name'; return false; }
  if (!pcategory.value.trim()) { msgEl.textContent = 'Enter category'; return false; }
  if (isNaN(Number(pqty.value)) || Number(pqty.value) < 0) { msgEl.textContent = 'Invalid quantity'; return false; }
  if (isNaN(Number(pprice.value)) || Number(pprice.value) < 0) { msgEl.textContent = 'Invalid purchase price'; return false; }
  if (isNaN(Number(psell.value)) || Number(psell.value) < 0) { msgEl.textContent = 'Invalid selling price'; return false; }
  return true;
}

function updateProduct() {
  if (!validate()) return;

  const updated = {
    name: pname.value.trim(),
    category: pcategory.value.trim(),
    quantity: Number(pqty.value),
    purchasePrice: Number(pprice.value),
    sellingPrice: Number(psell.value),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  updateBtn.disabled = true;
  updateBtn.textContent = 'Updating...';

  db.collection('products').doc(id).update(updated)
    .then(() => {
      // Create a friendly change message for logs (what changed & by how much)
      let changes = [];
      if (original) {
        if (original.name !== updated.name) changes.push(`name: "${original.name}" → "${updated.name}"`);
        if (original.category !== updated.category) changes.push(`category: "${original.category}" → "${updated.category}"`);
        if (original.quantity !== updated.quantity) changes.push(`qty: ${original.quantity} → ${updated.quantity}`);
        if (original.purchasePrice !== updated.purchasePrice) changes.push(`buy: ${original.purchasePrice} → ${updated.purchasePrice}`);
        if (original.sellingPrice !== updated.sellingPrice) changes.push(`sell: ${original.sellingPrice} → ${updated.sellingPrice}`);
      }

      // Add an update log with concise message
      try {
        const changedQty = original ? (updated.quantity - (original.quantity || 0)) : 0;
        addLog('UPDATE PRODUCT', updated.name, changedQty);
      } catch (e) { console.warn('Log not saved', e); }

      // Save last action (update) so user can undo on inventory page
      try {
        // Prepare a minimal snapshot of the updated values (avoid non-serializable fields)
        const updatedValues = {
          name: updated.name,
          category: updated.category,
          quantity: updated.quantity,
          purchasePrice: updated.purchasePrice,
          sellingPrice: updated.sellingPrice
        };

        const last = {
          type: 'update',
          id: id,
          data: original,        // previous values
          updated: updatedValues, // new values
          changes: changes,      // human-readable change list
          time: Date.now()
        };

        localStorage.setItem('smartstock_last_action', JSON.stringify(last));
        // enqueue a toast message for the inventory page to show after redirect
        try { localStorage.setItem('smartstock_toast', JSON.stringify({ message: 'Product updated successfully', type: 'success', duration: 3000 })); } catch(e) {}
      } catch (e) { console.warn('Could not persist last action', e); }

      msgEl.style.color = 'green';
      msgEl.textContent = '✅ Product updated successfully. Redirecting...';

      setTimeout(() => { window.location.href = 'inventory.html'; }, 900);
    })
    .catch(err => {
      console.error('Update error', err);
      msgEl.style.color = 'red';
      msgEl.textContent = 'Error: ' + (err.message || err);
      updateBtn.disabled = false;
      updateBtn.textContent = 'Update Product';
    });
}

function cancelEdit(){ window.location.href = 'inventory.html'; }
</script>
</body>
</html>
